{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - BYOD Security System{% endblock %}

{% block page_header %}
<div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <div class="px-4 py-6 lg:px-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    Welcome back, {{ user.get_full_name|default:user.username }}
                    {% if user_role %}({{ user_role|title }}){% endif %}
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="text-sm text-gray-500 dark:text-gray-400">{{ current_date|date:"F d, Y" }}</span>
                <button id="refresh-dashboard" class="btn btn-secondary btn-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Real-time stats display -->
<div id="real-time-stats" class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
    <div class="flex items-center">
        <div class="flex-shrink-0">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        </div>
        <div class="ml-3">
            <p class="text-sm text-blue-800 dark:text-blue-200">
                Live data - Last updated: <span id="last-updated">Loading...</span>
            </p>
        </div>
    </div>
</div>

{% if user_role == 'admin' %}
    <!-- Admin Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Users Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Users</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="total-users">{{ total_users }}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-green-600 dark:text-green-400 font-medium" id="active-users">{{ active_users_today }}</span>
                        <span class="text-gray-500 dark:text-gray-400 ml-1">active today</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Compliance Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Device Compliance</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="compliance-rate">{{ compliance_rate }}%</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-600 dark:text-gray-400" id="compliant-devices">{{ compliant_devices }}</span>
                        <span class="text-gray-500 dark:text-gray-400 ml-1">of {{ total_devices }} devices</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Sessions Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Sessions</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="active-sessions">{{ active_sessions }}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-600 dark:text-gray-400">{{ total_sessions_today }}</span>
                        <span class="text-gray-500 dark:text-gray-400 ml-1">sessions today</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Violations Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Security Violations</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ security_violations }}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Last 7 days</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Recent Device Registrations -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Device Registrations</h3>
            </div>
            <div class="card-content">
                {% if recent_registrations %}
                    <div class="space-y-3">
                        {% for device in recent_registrations %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ device.name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ device.user.username }} • {{ device.registered_at|date:"M d, H:i" }}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if device.compliance_status %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                                {% if device.compliance_status %}Compliant{% else %}Non-compliant{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent device registrations</p>
                {% endif %}
            </div>
        </div>

        <!-- Recent Security Violations -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Security Violations</h3>
            </div>
            <div class="card-content">
                {% if recent_violations %}
                    <div class="space-y-3">
                        {% for violation in recent_violations %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ violation.user.username }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ violation.device.name }} • {{ violation.login_time|date:"M d, H:i" }}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                {{ violation.violation_count }} violation{{ violation.violation_count|pluralize }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent security violations</p>
                {% endif %}
            </div>
        </div>
    </div>

{% elif user_role == 'teacher' %}
    <!-- Teacher Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Students Card -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Students</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_students }}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-green-600 dark:text-green-400 font-medium" id="active-students">{{ active_students_today }}</span>
                        <span class="text-gray-500 dark:text-gray-400 ml-1">active today</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Device Compliance -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Device Compliance</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ student_compliance_rate }}%</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-600 dark:text-gray-400">{{ total_student_devices }} student devices</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Productivity -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Productivity</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ avg_productivity }}%</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Last 7 days</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Attendance -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg Attendance</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ avg_attendance }}%</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Last 7 days</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Quick Actions and Data -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Recent Student Activity -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Student Activity</h3>
            </div>
            <div class="card-content">
                {% if recent_activity %}
                    <div class="space-y-3">
                        {% for activity in recent_activity %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ activity.user.username }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ activity.get_activity_type_display }} • {{ activity.timestamp|date:"M d, H:i" }}</p>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                {{ activity.duration_minutes|floatformat:0 }}m
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent student activity</p>
                {% endif %}
            </div>
        </div>

        <!-- Top Performing Students -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Top Performing Students</h3>
            </div>
            <div class="card-content">
                {% if top_students %}
                    <div class="space-y-3">
                        {% for report in top_students %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ report.user.username }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ report.report_date|date:"M d" }} • {{ report.attendance_percentage|floatformat:0 }}% attendance</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                {{ report.productivity_score|floatformat:0 }}%
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No performance reports available</p>
                {% endif %}
            </div>
        </div>
    </div>

{% elif user_role == 'student' %}
    <!-- Student Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- My Devices -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">My Devices</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_devices }}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-green-600 dark:text-green-400 font-medium">{{ compliant_devices }}</span>
                        <span class="text-gray-500 dark:text-gray-400 ml-1">compliant</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Activity -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Weekly Activity</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="activity-hours">{{ total_activity_hours|floatformat:1 }}h</p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">Last 7 days</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Productivity Score -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Productivity Score</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">
                            {% if latest_report %}{{ latest_report.productivity_score|floatformat:0 }}%{% else %}N/A{% endif %}
                        </p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">
                            {% if latest_report %}{{ latest_report.report_date|date:"M d" }}{% else %}No data{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance -->
        <div class="card">
            <div class="card-content">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Attendance</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">
                            {% if latest_report %}{{ latest_report.attendance_percentage|floatformat:0 }}%{% else %}N/A{% endif %}
                        </p>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center text-sm">
                        <span class="text-gray-500 dark:text-gray-400">
                            {% if latest_report %}{{ latest_report.report_date|date:"M d" }}{% else %}No data{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Activity and Sessions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">My Recent Activity</h3>
            </div>
            <div class="card-content">
                {% if recent_activity %}
                    <div class="space-y-3">
                        {% for activity in recent_activity %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ activity.get_activity_type_display }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ activity.device.name }} • {{ activity.timestamp|date:"M d, H:i" }}</p>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400">
                                {{ activity.duration_minutes|floatformat:0 }}m
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent activity</p>
                {% endif %}
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">My Recent Sessions</h3>
            </div>
            <div class="card-content">
                {% if recent_sessions %}
                    <div class="space-y-3">
                        {% for session in recent_sessions %}
                        <div class="flex items-center justify-between py-2 border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ session.device.name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ session.login_time|date:"M d, H:i" }} - {% if session.logout_time %}{{ session.logout_time|date:"H:i" }}{% else %}Active{% endif %}</p>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if session.status == 'active' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% elif session.status == 'violation' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                {{ session.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent sessions</p>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Quick Actions</h3>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {% if user_role == 'admin' %}
                <a href="{% url 'security:access_rules' %}" class="btn btn-primary btn-md w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Manage Access Rules
                </a>
                <a href="{% url 'security:session_monitor' %}" class="btn btn-secondary btn-md w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Monitor Sessions
                </a>
            {% elif user_role == 'teacher' %}
                <a href="{% url 'productivity:activity_logs' %}" class="btn btn-primary btn-md w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    View Activity Logs
                </a>
                <a href="{% url 'productivity:reports' %}" class="btn btn-secondary btn-md w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Generate Reports
                </a>
            {% endif %}
            
            <a href="{% url 'devices:device_list' %}" class="btn btn-secondary btn-md w-full">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                Manage Devices
            </a>
            
            <a href="{% url 'users:profile' %}" class="btn btn-secondary btn-md w-full">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                My Profile
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dashboard real-time updates
let updateInterval;

function updateDashboardStats() {
    fetch('{% url "dashboard:stats_api" %}')
        .then(response => response.json())
        .then(data => {
            // Update timestamp
            document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleTimeString();
            
            // Update role-specific stats
            {% if user_role == 'admin' %}
                if (data.active_sessions !== undefined) {
                    document.getElementById('active-sessions').textContent = data.active_sessions;
                }
                if (data.users_online !== undefined) {
                    document.getElementById('active-users').textContent = data.users_online;
                }
                if (data.compliance_rate !== undefined) {
                    document.getElementById('compliance-rate').textContent = data.compliance_rate + '%';
                }
            {% elif user_role == 'teacher' %}
                if (data.active_students !== undefined) {
                    document.getElementById('active-students').textContent = data.active_students;
                }
            {% elif user_role == 'student' %}
                if (data.today_activity_hours !== undefined) {
                    document.getElementById('activity-hours').textContent = data.today_activity_hours.toFixed(1) + 'h';
                }
            {% endif %}
        })
        .catch(error => {
            console.error('Error updating dashboard stats:', error);
        });
}

// Start real-time updates
function startRealTimeUpdates() {
    updateDashboardStats(); // Initial update
    updateInterval = setInterval(updateDashboardStats, 30000); // Update every 30 seconds
}

// Stop real-time updates
function stopRealTimeUpdates() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
}

// Manual refresh button
document.getElementById('refresh-dashboard').addEventListener('click', function() {
    updateDashboardStats();
    
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refreshing...';
    
    // Reset button after 2 seconds
    setTimeout(() => {
        this.disabled = false;
        this.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>Refresh';
    }, 2000);
});

// Start updates when page loads
document.addEventListener('DOMContentLoaded', function() {
    startRealTimeUpdates();
});

// Stop updates when page is hidden (performance optimization)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopRealTimeUpdates();
    } else {
        startRealTimeUpdates();
    }
});
</script>
{% endblock %}